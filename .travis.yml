sudo: required
services:
- docker
env:
  DOCKER_COMPOSE_VERSION: 1.18.0
branches:
  only:
  - master
  - develop
  - "/^(release).*$/"
  - "/^(hotfix).*$/"
  - "/^(feature).*$/"
language: node_js
node_js:
- '9'
before_install:
- wget -qO- https://toolbelt.heroku.com/install.sh | sh
- echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
- echo "$HEROKU_PASSWORD" | docker login -u "$HEROKU_USERNAME" --password-stdin registry.heroku.com
install:
- yarn install
script:
- yarn build
- docker build -t app .
deploy:
  - provider: script
    script:
      docker tag app registry.heroku.com/$HEROKU_APP_NAME_PROD/web;
      docker push app;
      docker push registry.heroku.com/$HEROKU_APP_NAME_PROD/web;
      heroku container:release web --app $HEROKU_APP_NAME_PROD
    on:
      branch: master
  - provider: script
    script:
      docker tag app registry.heroku.com/$HEROKU_APP_NAME_STAGE/web;
      docker push app;
      docker push registry.heroku.com/$HEROKU_APP_NAME_STAGE/web;
      heroku container:release web --app $HEROKU_APP_NAME_STAGE
    on:
      all_branches: true



  notifications:
  slack:
    secure: E73VMh/6VAsuImysVAez1v9X+jQafpB63u3vEv01ozA/jA5pVpqvjyvn46XMr9+XRTUV20vwVKTrewgHJr3RQyjIi2tfUJxSb4/7QCAoqYMgWmyy1zBgi2FboLmB5paIOJvdCbBXRCxU8FICgD6HMCdg2j4V8SJPxLZPIfJkNxH7HPZdJHYUrMLbSTdWTI2PJ5aeb8rDrQ3UUmzOf8mLL71rmCD2OKbT5/THZDonEcD9vzdY5blnDTPpHYAfkdV2IdceTa6SoSwIdme1XwIJdqFBp7AmcyeTCMRJLhy5hK2KtlqDKfCEepIkwkg/kcfaqz+pGJihilEVv7nAAYAglEQ1SBMvEnixaVeu0QXEWDiWK0+N1sHh3Ilvu7LmbtfIr5ETRjIgClhDlS5x0a/kf5Q5LHSJQT6wEjcStLF0FB0rVdAOZ8ZnAWzUtt20HLw+nC+g9JMU6lg2Ii2FDRPCWgKEBawiABKCeyEtLLqAoT1bR+PUSuCqqLW038bxRAEbkjVWgLVvdiAZKKIAdx49NRaNiPwqJHvfQi2zaUPG7iDHOGpnIEYi8pAEU2OyMP/sURfOWjDCiN9KYORzlOGfjxIRsGW5q20VjyuTqy90OhDm5KzgK8paBrtxEufYWpofX/XCa8PSvxTjvEgIl6YJSAl/yxcV+ZJ8NT9noixXXOk=
